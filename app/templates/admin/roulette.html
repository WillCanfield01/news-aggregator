{% extends "base.html" %}

{% block title %}Roulette Admin{% endblock %}

{% block head %}
<meta name="robots" content="noindex, nofollow">
<link rel="stylesheet" href="{{ url_for('static', filename='tools/tools.css') }}">
<style>
    .admin-shell {
        max-width: 640px;
        margin: 40px auto;
        background: #fff;
        padding: 24px;
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.04);
    }
    .admin-head {
        margin: 0 0 8px;
        font-size: 1.4rem;
        color: #0f172a;
    }
    .admin-note {
        margin: 0 0 16px;
        color: #475569;
    }
    .admin-actions {
        display: flex;
        gap: 12px;
        align-items: center;
    }
    .admin-status {
        margin-top: 12px;
        min-height: 20px;
        color: #475569;
        font-weight: 600;
    }
    .admin-status.success { color: #0f766e; }
    .admin-status.error { color: #b91c1c; }
</style>
{% endblock %}

{% block content %}
<section class="admin-shell" data-csrf="{{ csrf_token }}">
    <h1 class="admin-head">Roulette Admin</h1>
    <p class="admin-note">Re-run the Timeline Roulette generator. Use sparingly—one request at a time.</p>
    <div class="admin-actions">
        <button type="button" class="tool-run-btn" id="regenBtn">Regen now</button>
        <div id="badge" style="font-weight:700; color:#0f172a;"></div>
    </div>
    <div class="admin-status" id="status" aria-live="polite"></div>
</section>
<script>
(function() {
    const root = document.querySelector("[data-csrf]");
    const csrf = root ? root.dataset.csrf : "";
    const btn = document.getElementById("regenBtn");
    const statusEl = document.getElementById("status");
    const badge = document.getElementById("badge");

    function setStatus(text, type) {
        statusEl.textContent = text || "";
        statusEl.className = "admin-status" + (type ? ` ${type}` : "");
    }

    async function triggerRegen() {
        if (!btn) return;
        btn.disabled = true;
        badge.textContent = "";
        setStatus("Starting regen…");
        try {
            const res = await fetch("/admin/roulette/regen", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRF-Token": csrf || ""
                },
                body: JSON.stringify({ csrf_token: csrf || "" })
            });
            const data = await res.json().catch(() => ({}));
            if (!res.ok) {
                const err = data && data.error ? data.error : "Request failed";
                setStatus(`Error: ${err}`, "error");
            } else {
                setStatus(`Job started. ID: ${data.job_id}`, "success");
                if (data.status_url) {
                    badge.innerHTML = `<a href="${data.status_url}" target="_blank" rel="noopener noreferrer">Status link</a>`;
                }
            }
        } catch (e) {
            setStatus("Network error. Try again.", "error");
        }
        btn.disabled = false;
    }

    if (btn) {
        btn.addEventListener("click", triggerRegen);
    }
})();
</script>
{% endblock %}
