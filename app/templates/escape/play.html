{# app/templates/escape/play.html (REWRITE) #}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily Escape â€” Play</title>
  <style>
    :root {
      --bg: #0e1222;
      --panel: #151a2f;
      --panel2: #0f1427;
      --text: #f5f6fa;
      --muted: #99a3c7;
      --accent: #58bbff;
      --ok: #68f2a1;
      --warn: #ffd166;
      --bad: #ff6b6b;
      --shadow: rgba(0, 0, 0, 0.45);
      --card: #121832;
      --line: #223057;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: radial-gradient(1200px 800px at 50% -20%, #1a1f3e 0%, #0e1222 55%, #0e1222 100%);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .wrap {
      width: 100%;
      max-width: 820px;
      padding: 18px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border: 1px solid var(--line);
      border-radius: 14px;
      box-shadow: 0 10px 30px var(--shadow);
    }

    .brand {
      font-weight: 800;
      letter-spacing: 0.4px;
    }

    .meta {
      color: var(--muted);
      font-size: 14px;
    }

    .progress {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      margin-top: 10px;
    }

    .step {
      background: var(--panel2);
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 8px 10px;
      text-align: center;
      font-size: 14px;
      color: var(--muted);
    }

    .step.active {
      color: var(--text);
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent) inset;
    }

    .panel {
      margin-top: 14px;
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border: 1px solid var(--line);
      border-radius: 14px;
      box-shadow: 0 10px 30px var(--shadow);
      padding: 12px;
    }

    .center {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn {
      appearance: none;
      background: var(--accent);
      color: #08111e;
      border: none;
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 6px 18px rgba(88, 187, 255, 0.35);
    }

    .btn[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .muted {
      color: var(--muted);
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .timer {
      font-weight: 800;
      letter-spacing: 0.4px;
    }

    .ads {
      margin-top: 12px;
      height: 64px;
      border: 1px dashed var(--line);
      border-radius: 12px;
      color: var(--muted);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .share {
      white-space: pre;
      background: #0b1225;
      padding: 8px 10px;
      border: 1px solid var(--line);
      border-radius: 8px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }

    /* Vault Frenzy UI */
    .vf-grid {
      display: grid;
      gap: 10px;
      touch-action: manipulation;
    }

    .vf-cell {
      width: 86px;
      height: 86px;
      border-radius: 14px;
      background: #121832;
      border: 1px solid #223057;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
      user-select: none;
      transition: transform .06s ease;
    }

    .vf-cell:active {
      transform: scale(0.96);
    }

    /* Light Reactor UI */
    .reactor {
      position: relative;
      width: 320px;
      height: 320px;
      border-radius: 50%;
      background: #0e1a34;
      border: 2px solid #20335f;
      box-shadow: inset 0 0 60px rgba(32, 64, 128, .45);
    }

    .reactor .target {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 280px;
      height: 280px;
      margin: -140px 0 0 -140px;
      border-radius: 50%;
      border: 2px dashed #2954a8;
    }

    .reactor .orb {
      position: absolute;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #58bbff;
      box-shadow: 0 0 14px rgba(88, 187, 255, .9);
    }

    .reactor .zone {
      position: absolute;
      width: 260px;
      height: 260px;
      margin: -130px 0 0 -130px;
      top: 50%;
      left: 50%;
      border-radius: 50%;
      border: 4px solid rgba(104, 242, 161, .45);
    }

    .reactor .cta {
      position: absolute;
      bottom: 14px;
      left: 50%;
      transform: translateX(-50%);
    }

    /* Pressure Chamber UI */
    .pc-wrap {
      display: flex;
      gap: 12px;
    }

    .pc-valve {
      width: 70px;
      background: #0f1a33;
      border: 1px solid #223057;
      border-radius: 10px;
      padding: 6px;
    }

    .pc-gauge {
      height: 160px;
      background: linear-gradient(0deg, #1c2b5c, #14305a);
      border-radius: 6px;
      overflow: hidden;
      position: relative;
    }

    .pc-fill {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 0%;
      background: linear-gradient(180deg, #68f2a1, #2a7f55);
      box-shadow: inset 0 0 18px rgba(0, 0, 0, .35);
      transition: height .12s linear;
    }

    .pc-btn {
      margin-top: 6px;
      width: 100%;
      font-weight: 700;
    }

    /* Finish */
    .finish {
      text-align: center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <div class="brand">Daily Escape</div>
        <div class="meta"><span id="todayMeta"></span> â€¢ <span class="timer" id="globalTimer">0:00</span></div>
      </div>
      <div class="row">
        <button id="muteBtn" class="btn" style="background:#263a5f;color:#cfe2ff">ðŸ”‡ Sound</button>
        <a href="/escape/leaderboard" class="btn" style="background:#1cf29f;">Leaderboard</a>
      </div>
    </header>

    <div class="progress">
      <div class="step active" id="stepA">â—† Vault Frenzy</div>
      <div class="step" id="stepB">â—Ž Light Reactor</div>
      <div class="step" id="stepC">âœ¶ Pressure Chamber</div>
    </div>

    <div class="panel" id="panel">
      <div id="intro" class="center" style="flex-direction:column; padding:20px;">
        <h2 style="margin:4px 0 10px;">Ready to escape?</h2>
        <p class="muted" style="text-align:center; max-width:520px;">
          Three quick minigames. One escape. Finish as fast as you can.
        </p>
        <div class="ads">Ad slot</div>
        <div style="height:8px;"></div>
        <button id="startBtn" class="btn">Start</button>
      </div>

      <div id="gameA" style="display:none;"></div>
      <div id="gameB" style="display:none;"></div>
      <div id="gameC" style="display:none;"></div>

      <div id="finish" class="finish" style="display:none;">
        <h2>Escaped!</h2>
        <p>Total time: <b><span id="totalMs"></span> ms</b></p>
        <div class="row center" style="justify-content:center;">
          <div id="shareBlock" class="share"></div>
        </div>
        <div style="height:10px;"></div>
        <a href="/escape/leaderboard" class="btn">See Leaderboard</a>
      </div>
    </div>
  </div>

  <script>
    /* =======================  Daily Escape â€“ minis client  ======================= */

    (function () {
      // ---------- helpers ----------
      const qs = new URLSearchParams(location.search);
      const todayISO = () => new Date().toISOString().slice(0, 10);
      const $ = (sel) => document.querySelector(sel);
      const $$ = (sel) => Array.from(document.querySelectorAll(sel));

      // ---------- state ----------
      const state = {
        dateKey: qs.get("date") || todayISO(),
        minis: [],             // [{slot, puzzleId, mechanic, prompt, ui}]
        current: 0,
        solved: [false, false, false],
        startedMs: null,
        timerHandle: null,
        soundOn: (localStorage.getItem("escape_sound") || "on") === "on",
      };

      // ---------- boot ----------
      document.addEventListener("DOMContentLoaded", init);

      async function init() {
        try {
          await fetchToday();
          wireUI();
        } catch (err) {
          console.error(err);
          alert("Failed to load todayâ€™s game. Please refresh.");
        }
      }

      // ---------- data ----------
      async function fetchToday() {
        const url = `/escape/api/today?format=minis&date=${encodeURIComponent(state.dateKey)}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error("today fetch failed");
        const data = await res.json();

        // normalize minis (server provides puzzle_id; keep slot for tab label if present)
        state.minis = (data.minigames || []).map((m) => ({
          slot: m.slot || m.id,
          puzzleId: m.puzzle_id || m.id,
          mechanic: (m.mechanic || "").toLowerCase(), // 'sequence_input' | 'grid_input'
          prompt: m.prompt || "",
          ui: m.ui_spec || {},                         // {sequence:[...]} or {grid:[[]]}
        }));

        // header text
        const metaEl = $("#todayMeta");
        if (metaEl) {
          const theme = data.theme || "Daily Escape";
          metaEl.textContent = `${data.date || state.dateKey} â€¢ ${theme}`;
        }
      }

      // ---------- ui wiring ----------
      function wireUI() {
        // â€œStartâ€ button shows first mini
        const startBtn = $("#startBtn");
        if (startBtn) startBtn.onclick = startRun;

        // Step tabs (A/B/C)
        const steps = [$("#stepA"), $("#stepB"), $("#stepC")];
        steps.forEach((el, i) => {
          if (!el) return;
          el.style.cursor = "pointer";
          el.onclick = () => { setActiveStep(i); launch(i); };
        });

        // Sound toggle (optional)
        const soundBtn = $("#soundToggle");
        if (soundBtn) {
          setSoundVisual(soundBtn, state.soundOn);
          soundBtn.onclick = () => {
            state.soundOn = !state.soundOn;
            localStorage.setItem("escape_sound", state.soundOn ? "on" : "off");
            setSoundVisual(soundBtn, state.soundOn);
          };
        }
      }

      function setSoundVisual(btn, on) {
        btn.classList.toggle("is-on", !!on);
        btn.setAttribute("aria-pressed", on ? "true" : "false");
      }

      function startRun() {
        const intro = $("#intro");
        if (intro) intro.style.display = "none";
        state.startedMs = Date.now();
        startTimer();
        setActiveStep(0);
        launch(0);
      }

      function setActiveStep(i) {
        ["#stepA", "#stepB", "#stepC"].forEach((sel, idx) => {
          const el = $(sel);
          if (!el) return;
          el.classList.toggle("active", idx === i);
          el.classList.toggle("solved", state.solved[idx]);
        });
      }

      // ---------- timer ----------
      function startTimer() {
        const timerEl = $("#timer") || document.querySelector("[data-run-timer]");
        stopTimer();
        state.timerHandle = setInterval(() => {
          if (!timerEl || !state.startedMs) return;
          const secs = Math.max(0, Math.floor((Date.now() - state.startedMs) / 1000));
          const m = Math.floor(secs / 60);
          const s = secs % 60;
          timerEl.textContent = `${m}:${s.toString().padStart(2, "0")}`;
        }, 1000);
      }
      function stopTimer() {
        if (state.timerHandle) {
          clearInterval(state.timerHandle);
          state.timerHandle = null;
        }
      }

      // ---------- launch & mount ----------
      function launch(i) {
        state.current = i;

        // swap visible panel (#gameA/B/C)
        const hostIds = ["#gameA", "#gameB", "#gameC"];
        hostIds.forEach((sel, idx) => {
          const pane = $(sel);
          if (!pane) return;
          pane.style.display = idx === i ? "block" : "none";
          if (idx !== i) pane.innerHTML = ""; // clear others
        });

        const host = $(hostIds[i]);
        const mini = state.minis[i];
        if (!host) return;
        if (!mini) { host.textContent = "No mini available."; return; }

        // title
        const h = document.createElement("h2");
        h.className = "mini-title";
        h.textContent = titleFor(mini);
        host.appendChild(h);

        // prompt
        if (mini.prompt) {
          const p = document.createElement("p");
          p.className = "mini-prompt";
          p.textContent = mini.prompt;
          host.appendChild(p);
        }

        if (mini.mechanic === "sequence_input") {
          mountSequence(host, mini);
        } else if (mini.mechanic === "grid_input") {
          mountGrid(host, mini);
        } else {
          const p = document.createElement("p");
          p.textContent = "Unknown mini type.";
          host.appendChild(p);
        }
      }

      function titleFor(mini) {
        // Basic mapping; tweak labels as you like
        return (mini.slot ? mini.slot + " â€¢ " : "") +
          (mini.mechanic === "grid_input" ? "Light Reactor" : "Vault Frenzy");
      }

      // ---------- minis: sequence ----------
      function mountSequence(host, mini) {
        const choices = Array.isArray(mini.ui.sequence) && mini.ui.sequence.length
          ? mini.ui.sequence
          : ["tap", "hold", "up", "down", "left", "right"]; // safe default

        const bar = document.createElement("div");
        bar.className = "chip-bar";

        const preview = document.createElement("div");
        preview.className = "chip-output";

        let out = [];

        // chip buttons
        choices.forEach((tok) => {
          const b = document.createElement("button");
          b.className = "chip";
          b.textContent = tok;
          b.onclick = () => {
            out.push(tok);
            preview.textContent = out.join(", ");
            clickTick();
          };
          bar.appendChild(b);
        });

        // controls
        const ctrl = document.createElement("div");
        ctrl.className = "chip-controls";

        const clearBtn = document.createElement("button");
        clearBtn.textContent = "Clear";
        clearBtn.onclick = () => { out = []; preview.textContent = ""; };

        const backBtn = document.createElement("button");
        backBtn.textContent = "âŒ«";
        backBtn.title = "Backspace";
        backBtn.onclick = () => { out.pop(); preview.textContent = out.join(", "); };

        const goBtn = document.createElement("button");
        goBtn.textContent = "Go";
        goBtn.onclick = () => submit(mini.puzzleId, out.join(","));

        ctrl.append(clearBtn, backBtn, goBtn);

        host.append(bar, preview, ctrl);
      }

      // ---------- minis: grid ----------
      function mountGrid(host, mini) {
        const grid = Array.isArray(mini.ui.grid) ? mini.ui.grid : null;
        if (!grid) {
          const p = document.createElement("p");
          p.textContent = "Grid missing.";
          host.appendChild(p);
          return;
        }

        const wrap = document.createElement("div");
        wrap.className = "grid";

        const preview = document.createElement("div");
        preview.className = "grid-preview";

        const sel = []; // [{r,c,ch}]
        function adjacent(a, b) {
          if (!a || !b) return true;
          const dr = Math.abs(a.r - b.r);
          const dc = Math.abs(a.c - b.c);
          return (dr + dc) === 1; // 4-neighborhood
        }

        for (let r = 0; r < grid.length; r++) {
          const rowEl = document.createElement("div");
          rowEl.className = "grid-row";
          for (let c = 0; c < grid[r].length; c++) {
            const cell = document.createElement("button");
            cell.className = "grid-cell";
            cell.textContent = grid[r][c];

            cell.onclick = () => {
              const last = sel[sel.length - 1] || null;
              const next = { r, c, ch: grid[r][c] };
              if (!adjacent(last, next)) return; // ignore non-adjacent taps
              sel.push(next);
              preview.textContent = sel.map(x => x.ch).join("");
              cell.classList.add("picked");
              clickTick();
            };

            rowEl.appendChild(cell);
          }
          wrap.appendChild(rowEl);
        }

        const ctrl = document.createElement("div");
        ctrl.className = "grid-controls";

        const clearBtn = document.createElement("button");
        clearBtn.textContent = "Clear";
        clearBtn.onclick = () => {
          sel.length = 0;
          preview.textContent = "";
          $$(".grid-cell.picked").forEach((n) => n.classList.remove("picked"));
        };

        const backBtn = document.createElement("button");
        backBtn.textContent = "âŒ«";
        backBtn.onclick = () => {
          if (!sel.length) return;
          sel.pop();
          preview.textContent = sel.map(x => x.ch).join("");
          // remove last picked style
          const picked = $$(".grid-cell.picked");
          if (picked.length) picked[picked.length - 1].classList.remove("picked");
        };

        const goBtn = document.createElement("button");
        goBtn.textContent = "Go";
        goBtn.onclick = () => submit(mini.puzzleId, sel.map(x => x.ch).join(""));

        ctrl.append(clearBtn, backBtn, goBtn);

        host.append(wrap, preview, ctrl);
      }

      // ---------- submit ----------
      async function submit(puzzleId, answer) {
        if (!puzzleId) {
          alert("Internal error: missing puzzle id");
          return;
        }
        try {
          const res = await fetch("/escape/api/submit", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ date_key: state.dateKey, puzzle_id: puzzleId, answer })
          });
          const data = await res.json();
          if (data.correct) {
            solvedCurrent(data.fragment);
          } else {
            buzz();
            alert("Try again.");
          }
        } catch (e) {
          console.error(e);
          alert("Network error. Please try again.");
        }
      }

      function solvedCurrent(fragment) {
        const i = state.current;
        state.solved[i] = true;
        ["#stepA", "#stepB", "#stepC"][i] && $(["#stepA", "#stepB", "#stepC"][i]).classList.add("solved");

        // Simple toast
        if (fragment) console.log("Fragment:", fragment);

        // Advance or finish
        const next = state.solved.findIndex((v, idx) => !v && idx > i);
        const firstUnsolved = state.solved.findIndex((v) => !v);
        if (firstUnsolved === -1) {
          finishRun(true);
        } else {
          setActiveStep(firstUnsolved);
          launch(firstUnsolved);
        }
      }

      async function finishRun(success) {
        stopTimer();
        try {
          await fetch("/escape/api/finish", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              date_key: state.dateKey,
              started_ms: state.startedMs || Date.now(),
              success: !!success,
              meta: { chips_left: 0 } // optionally add extras (routes chosen, hints, etc.)
            }),
          });
        } catch (e) {
          console.warn("finish error:", e);
        }
        // Redirect to leaderboard for today's date
        location.href = `/escape/leaderboard?date=${encodeURIComponent(state.dateKey)}`;
      }

      // ---------- tiny sfx hooks ----------
      function clickTick() {
        // noop for now (soundOn gated); keep for future sfx
      }
      function buzz() {
        if (!("vibrate" in navigator)) return;
        try { navigator.vibrate(80); } catch (_) { }
      }
    })();
  </script>

</body>

</html>