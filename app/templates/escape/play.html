<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Mini Escape — {{ date_key }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            --bg: #0f1220;
            --panel: #151a2f;
            --panel2: #0f1427;
            --text: #e6eaf6;
            --muted: #9aa3c7;
            --brand: #58bbff;
            --ok: #55d38e;
            --err: #ff6b6b;
            --shadow: rgba(0, 0, 0, .35)
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            background: radial-gradient(1200px 900px at 10% 0%, #121735 0%, #0f1220 50%, #0b0f1c 100%);
            color: var(--text);
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif
        }

        .wrap {
            max-width: 960px;
            margin: 0 auto;
            padding: 20px 16px 80px
        }

        header {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 12px
        }

        .title {
            font-size: 22px;
            font-weight: 800
        }

        .badge {
            padding: 4px 10px;
            border-radius: 999px;
            background: linear-gradient(180deg, #172042, #121a38);
            border: 1px solid #26325f;
            color: #b6c4ff
        }

        .timer {
            margin-left: auto;
            font-variant-numeric: tabular-nums;
            font-weight: 700;
            background: linear-gradient(180deg, #172042, #121a38);
            border: 1px solid #26325f;
            border-radius: 10px;
            padding: 6px 10px
        }

        .intro,
        .panel {
            background: linear-gradient(180deg, #151a2f, #0f1427);
            border: 1px solid #24305b;
            border-radius: 14px;
            box-shadow: 0 10px 30px var(--shadow)
        }

        .intro {
            padding: 14px;
            margin: 10px 0 14px
        }

        .row {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap
        }

        button,
        .btn {
            background: linear-gradient(180deg, #1c2a4e, #152244);
            border: 1px solid #2a3c73;
            color: #cfe3ff;
            border-radius: 10px;
            padding: 10px 14px;
            cursor: pointer;
            text-decoration: none
        }

        button:hover,
        .btn:hover {
            filter: brightness(1.06)
        }

        input[type=text] {
            flex: 1;
            min-width: 200px;
            background: #0b1226;
            border: 1px solid #24305b;
            color: var(--text);
            border-radius: 10px;
            padding: 10px 12px
        }

        .scene {
            padding: 12px;
            margin: 10px 0;
            display: none
        }

        .scene.active {
            display: block
        }

        .scene h3 {
            margin: 4px 0 6px
        }

        .route-btns {
            display: flex;
            gap: 8px;
            flex-wrap: wrap
        }

        .p-card {
            margin-top: 8px;
            padding: 10px;
            background: #0f1427;
            border: 1px solid #22305d;
            border-radius: 12px
        }

        .status {
            font-size: 13px;
            color: var(--muted)
        }

        .status.ok {
            color: var(--ok)
        }

        .status.err {
            color: var(--err)
        }

        .hint-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 6px
        }

        .hint-pill {
            background: #0f1730;
            border: 1px dashed #2a3769;
            color: #a9b4e6;
            border-radius: 999px;
            padding: 6px 10px;
            cursor: pointer
        }

        .hint-text {
            margin-top: 4px;
            background: #0c1428;
            border: 1px solid #25305a;
            border-radius: 8px;
            padding: 8px 10px;
            display: none
        }

        .footer {
            margin-top: 16px;
            padding: 12px
        }

        .final {
            display: none
        }

        .notes {
            position: sticky;
            top: 10px
        }

        textarea {
            width: 100%;
            min-height: 160px;
            background: #0b1226;
            border: 1px solid #24305b;
            color: var(--text);
            border-radius: 10px;
            padding: 8px
        }

        .two-col {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 14px
        }

        @media (max-width:900px) {
            .two-col {
                grid-template-columns: 1fr
            }
        }

        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(7, 10, 18, .6);
            backdrop-filter: blur(6px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50
        }

        .start {
            width: min(680px, 92vw);
            background: linear-gradient(180deg, #141a30, #0f1427);
            border: 1px solid #24305b;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 60px var(--shadow);
            text-align: center
        }

        .hidden {
            display: none !important
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #0e182e;
            color: #dce4ff;
            border: 1px solid #2c3a69;
            padding: 10px 12px;
            border-radius: 10px;
            box-shadow: 0 10px 30px var(--shadow);
            opacity: 0;
            transform: translateY(10px);
            transition: .2s;
            z-index: 60
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0)
        }

        .chip-flash {
            animation: chipflash .4s ease
        }

        @keyframes chipflash {
            0% {
                filter: brightness(1.3)
            }

            100% {
                filter: brightness(1)
            }
        }

        .tiny {
            font-size: 12px;
            color: #9aa3c7
        }
    </style>
</head>

<body>
    <!-- Start overlay -->
    <div id="overlay" class="overlay">
        <div class="start">
            <div style="font-size:22px;font-weight:800;margin-bottom:6px;">Mini Escape — Daily Trail</div>
            <div style="color:#b6c4ff">
                Three scenes, one final lock. Pick a route each scene, solve, collect fragments, then unlock the door.
            </div>
            <div class="row" style="justify-content:center;margin-top:10px;">
                <button id="startBtn" style="background:#1b7bc0;border-color:#2f8bd5">Start Today’s Escape</button>
                <a class="badge" href="/escape/leaderboard?date={{ date_key }}" target="_blank" rel="noopener">View
                    Leaderboard</a>
            </div>
            <div style="color:#9aa3c7;font-size:12px;margin-top:6px;">
                Date: <b>{{ date_key }}</b> • Difficulty: {{ difficulty|default('medium')|title }}
            </div>
            <div class="tiny" style="margin-top:10px;">
                Hints cost chips. “Move quickly” doubles hint costs and delays hints by +30s.
            </div>
        </div>
    </div>

    <div class="wrap">
        <header>
            <div class="title">Mini Escape — <span id="dateKey">{{ date_key }}</span></div>
            <span class="badge">Difficulty: <b id="difficulty">{{ difficulty|default('medium')|title }}</b></span>
            <span class="badge" id="sceneBadge">Scene 1 of 3</span>
            <span class="badge" id="chipsBadge">Chips: —</span>
            <div id="timer" class="timer">00:00.000</div>
        </header>

        <div class="two-col">
            <main>
                <section class="intro panel">
                    <div id="roomTitle" style="font-weight:800;margin-bottom:6px;">Loading…</div>
                    <div id="roomIntro" style="color:#c8d4ff">Please wait…</div>
                </section>

                <!-- Scenes injected here -->
                <section id="scenes"></section>

                <!-- Final gate -->
                <section class="footer panel final" id="finalGate">
                    <div><strong>Final Code</strong> — Combine what you’ve learned.</div>
                    <div class="row" style="margin-top:6px;">
                        <input id="finalInput" type="text" placeholder="Enter final code…" autocomplete="off" />
                        <button id="finishBtn">Finish & Submit Time</button>
                    </div>
                    <div id="finalStatus" class="status"></div>

                    <div id="share"
                        style="display:none;margin-top:10px;border:1px dashed #2a3769;border-radius:12px;padding:10px;color:#b6c4ff">
                        <div id="shareText">Share your time!</div>
                        <div class="row" style="margin-top:8px;">
                            <button id="copyBtn">Copy Result</button>
                            <a class="btn" href="/escape/leaderboard?date={{ date_key }}" target="_blank"
                                rel="noopener">View Leaderboard</a>
                        </div>
                    </div>
                </section>
            </main>

            <!-- Notes -->
            <aside class="notes">
                <div class="panel" style="padding:12px;">
                    <div style="font-weight:700;margin-bottom:6px;">Notes</div>
                    <textarea id="notesBox" placeholder="Jot down letters, codes, fragments…"></textarea>
                    <div class="row" style="margin-top:8px;">
                        <button id="clearNotes">Clear</button>
                        <span id="saveStamp" class="status" style="margin-left:auto;">Autosaved</span>
                    </div>
                    <div class="tiny" style="margin-top:6px;">Notes are saved locally per day.</div>
                </div>
            </aside>
        </div>
    </div>

    <div id="toast" class="toast">Saved</div>

    <script>
        // ---------- Config (client) ----------
        const CHIPS_START = 100;
        const HINT_COST = {
            cautious: { h1: 5, h2: 10 },
            brisk: { h1: 10, h2: 20 }  // doubled cost
        };
        const HINT_DELAY_BONUS = { cautious: 0, brisk: 30 }; // +seconds to both hints if brisk
        const CHIPS_TO_MS = 50; // time bonus: 1 chip = 50 ms (server should mirror)

        // ---------- State ----------
        const state = {
            dateKey: "{{ date_key }}",
            startedMs: null,
            tickHandle: null,
            room: null,
            currentScene: 0,
            solvedScenes: [false, false, false],
            chosenRoutes: [null, null, null], // "cautious"|"brisk"
            hintPolicy: { first_hint_delay_s: 60, second_hint_delay_s: 120 },
            chips: CHIPS_START,
            spent: 0,
            hintsUsed: [{ h1: false, h2: false }, { h1: false, h2: false }, { h1: false, h2: false }],
        };

        // ---------- Helpers ----------
        const $ = id => document.getElementById(id);
        const fmtTime = ms => {
            const m = Math.floor(ms / 60000), s = Math.floor((ms % 60000) / 1000), ms3 = String(ms % 1000).padStart(3, "0");
            return `${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}.${ms3}`;
        };
        function toast(msg) { const t = $("toast"); t.textContent = msg; t.classList.add("show"); setTimeout(() => t.classList.remove("show"), 1600); }
        function updateChipsBadge() { const b = $("chipsBadge"); b.textContent = `Chips: ${state.chips}`; b.classList.add("chip-flash"); setTimeout(() => b.classList.remove("chip-flash"), 300); }

        // ---------- Notes (localStorage per day) ----------
        const NOTES_KEY = d => `trail-notes-${d}`;
        function loadNotes() { $("notesBox").value = localStorage.getItem(NOTES_KEY(state.dateKey)) || ""; }
        function saveNotes() { localStorage.setItem(NOTES_KEY(state.dateKey), $("notesBox").value); $("saveStamp").textContent = "Saved"; setTimeout(() => $("saveStamp").textContent = "Autosaved", 900); }
        $("notesBox").addEventListener("input", () => { $("saveStamp").textContent = "…"; saveNotes(); });
        $("clearNotes").addEventListener("click", () => { $("notesBox").value = ""; saveNotes(); });

        // ---------- Start / Timer ----------
        $("startBtn").addEventListener("click", async () => {
            $("overlay").classList.add("hidden");
            await fetchRoom();
            startTimer();
            loadNotes();
            updateChipsBadge();
        });
        function startTimer() { state.startedMs = Date.now(); state.tickHandle = setInterval(() => { $("timer").textContent = fmtTime(Date.now() - state.startedMs); }, 33); }
        function stopTimer() { if (state.tickHandle) { clearInterval(state.tickHandle); state.tickHandle = null; } }

        // ---------- Fetch room ----------
        async function fetchRoom() {
            const res = await fetch(`/escape/api/today?date=${encodeURIComponent(state.dateKey)}`, { cache: "no-store" });
            const room = await res.json();
            state.room = room;
            $("roomTitle").textContent = room.title || "Today's Trail";
            $("roomIntro").textContent = room.intro || "";
            state.hintPolicy = room.server_hint_policy || state.hintPolicy;
            renderScenes(room);
            updateSceneBadge();
        }

        // ---------- Render scenes ----------
        function renderScenes(room) {
            const holder = $("scenes"); holder.innerHTML = "";
            const rooms = (room.trail && room.trail.rooms) ? room.trail.rooms : [];

            rooms.forEach((rm, idx) => {
                const wrap = document.createElement("section");
                wrap.className = "scene panel" + (idx === 0 ? " active" : "");
                wrap.id = `scene-${idx}`;
                wrap.innerHTML = `
          <h3>Scene ${idx + 1}: ${rm.title || ""}</h3>
          <div style="color:#c8d4ff">${rm.text || ""}</div>

          <div class="tiny" style="margin-top:6px;">Choose a route:</div>
          <div class="route-btns" style="margin-top:4px;">
            <button data-route="cautious" title="Normal hint cost / normal hint timing">Proceed carefully (1×)</button>
            <button data-route="brisk" title="Hints cost 2× chips and unlock +30s later">Move quickly (2×)</button>
          </div>

          <div class="p-card" id="pzwrap-${idx}" style="display:none;">
            <div class="tiny" id="routeLabel-${idx}" style="margin-bottom:6px;"></div>
            <div id="pzp-${idx}" style="white-space:pre-wrap;"></div>
            <div class="row" style="margin-top:6px;">
              <input id="pzin-${idx}" type="text" placeholder="Type your answer…"/>
              <button id="pzbtn-${idx}">Submit</button>
            </div>
            <div id="pzstatus-${idx}" class="status">Awaiting answer…</div>

            <div class="hint-row">
              <button class="hint-pill" id="h1btn-${idx}">Reveal Hint 1</button>
              <button class="hint-pill" id="h2btn-${idx}">Reveal Hint 2</button>
            </div>
            <div class="hint-text" id="h1txt-${idx}"></div>
            <div class="hint-text" id="h2txt-${idx}"></div>
            <div class="tiny" id="hintCost-${idx}" style="margin-top:6px;"></div>
          </div>

          <div class="row" style="margin-top:8px;">
            <button class="btn" id="next-${idx}" style="display:none;">Next scene →</button>
          </div>
        `;
                holder.appendChild(wrap);

                // Route selection
                wrap.querySelectorAll(".route-btns button").forEach(b => {
                    b.addEventListener("click", () => {
                        const route = b.getAttribute("data-route");
                        state.chosenRoutes[idx] = route;
                        showPuzzle(idx, rm, route);
                        wrap.querySelectorAll(".route-btns button").forEach(x => x.disabled = true);
                    });
                });
            });

            $("finalGate").style.display = "none";
        }

        function showPuzzle(idx, rm, routeId) {
            const route = (rm.routes || []).find(r => r.id === routeId) || (rm.routes || [])[0] || {};
            const p = route.puzzle || {};
            const pw = $(`pzwrap-${idx}`); pw.style.display = "block";
            $(`pzp-${idx}`).textContent = p.prompt || "Puzzle";
            $(`routeLabel-${idx}`).textContent = `Route: ${routeId} (Hint costs — H1: ${HINT_COST[routeId].h1} chips, H2: ${HINT_COST[routeId].h2} chips)`;
            $(`hintCost-${idx}`).textContent = `Your chips: ${state.chips}. Using hints will deduct chips permanently.`;

            const input = $(`pzin-${idx}`), btn = $(`pzbtn-${idx}`), status = $(`pzstatus-${idx}`);
            const h1btn = $(`h1btn-${idx}`), h2btn = $(`h2btn-${idx}`), h1txt = $(`h1txt-${idx}`), h2txt = $(`h2txt-${idx}`);

            // Hint timers include route delay modifier
            function updateHints() {
                if (!state.startedMs) return;
                const elapsed = Date.now() - state.startedMs;
                const boost = HINT_DELAY_BONUS[routeId] || 0;
                const d1 = ((state.hintPolicy.first_hint_delay_s ?? 60) + boost) * 1000;
                const d2 = ((state.hintPolicy.second_hint_delay_s ?? 120) + boost) * 1000;
                h1btn.disabled = elapsed < d1;
                h1btn.textContent = h1btn.disabled ? `Hint 1 in ${Math.max(0, Math.ceil((d1 - elapsed) / 1000))}s` : `Reveal Hint 1 (-${HINT_COST[routeId].h1})`;
                h2btn.disabled = elapsed < d2;
                h2btn.textContent = h2btn.disabled ? `Hint 2 in ${Math.max(0, Math.ceil((d2 - elapsed) / 1000))}s` : `Reveal Hint 2 (-${HINT_COST[routeId].h2})`;
            }
            updateHints(); const iv = setInterval(updateHints, 250);

            function spend(cost) {
                if (state.chips < cost) { toast("Not enough chips for that hint."); return false; }
                state.chips -= cost; state.spent += cost; updateChipsBadge();
                return true;
            }

            h1btn.onclick = () => {
                if (h1btn.disabled) return;
                if (!state.hintsUsed[idx].h1) {
                    if (!spend(HINT_COST[routeId].h1)) return;
                    state.hintsUsed[idx].h1 = true;
                }
                h1txt.textContent = (p.hints || [])[0] || "No hint provided.";
                h1txt.style.display = "block";
            };

            h2btn.onclick = () => {
                if (h2btn.disabled) return;
                if (!state.hintsUsed[idx].h2) {
                    if (!spend(HINT_COST[routeId].h2)) return;
                    state.hintsUsed[idx].h2 = true;
                }
                h2txt.textContent = (p.hints || [])[1] || "No additional hint.";
                h2txt.style.display = "block";
            };

            btn.onclick = async () => {
                const answer = (input.value || "").trim();
                if (!answer) { status.textContent = "Enter an answer."; status.className = "status"; return; }
                status.textContent = "Checking…"; status.className = "status";
                try {
                    const res = await fetch(`/escape/api/submit`, {
                        method: "POST", headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ date_key: state.dateKey, puzzle_id: p.id, answer })
                    });
                    const data = await res.json();
                    if (data && data.correct) {
                        status.textContent = "Correct! Fragment secured."; status.className = "status ok";
                        input.disabled = true; btn.disabled = true; clearInterval(iv);
                        state.solvedScenes[idx] = true;
                        const nextBtn = $(`next-${idx}`);
                        if (idx < 2) { nextBtn.style.display = "inline-block"; nextBtn.onclick = () => goToScene(idx + 1); }
                        else { revealFinal(); }
                    } else {
                        status.textContent = "Not yet. Try another angle."; status.className = "status err";
                    }
                } catch (e) {
                    status.textContent = "Network error — try again."; status.className = "status err";
                }
            };

            input.addEventListener("keydown", e => { if (e.key === "Enter") btn.click(); });
        }

        function goToScene(idx) {
            document.querySelectorAll(".scene").forEach(s => s.classList.remove("active"));
            $(`scene-${idx}`).classList.add("active");
            state.currentScene = idx;
            updateSceneBadge();
        }
        function updateSceneBadge() { $("sceneBadge").textContent = `Scene ${state.currentScene + 1} of 3`; }

        function revealFinal() {
            if (state.solvedScenes.every(Boolean)) {
                $("finalGate").style.display = "block";
                goToScene(2);
            }
        }

        // ---------- Finish ----------
        $("finishBtn").addEventListener("click", async () => {
            if (!state.solvedScenes.every(Boolean)) { toast("Solve all scenes first."); return; }
            const finalVal = ($("finalInput").value || "").trim();
            if (!finalVal) { $("finalStatus").textContent = "Enter the final code."; $("finalStatus").className = "status err"; return; }

            try {
                const res = await fetch(`/escape/api/finish`, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        date_key: state.dateKey,
                        started_ms: state.startedMs,
                        success: true,
                        final_code: finalVal,
                        meta: {
                            ua: navigator.userAgent,
                            tz: Intl.DateTimeFormat().resolvedOptions().timeZone || null,
                            width: window.innerWidth, height: window.innerHeight,
                            chips_start: CHIPS_START,
                            chips_spent: state.spent,
                            chips_remaining: state.chips,
                            chips_to_ms: CHIPS_TO_MS,
                            routes: state.chosenRoutes,
                            hints_used: state.hintsUsed
                        }
                    })
                });
                const data = await res.json();
                if (!res.ok || !data.ok) { $("finalStatus").textContent = data.error || "Submission failed."; $("finalStatus").className = "status err"; return; }
                if (!data.success) { $("finalStatus").textContent = "Final check failed. Re-check your fragments."; $("finalStatus").className = "status err"; return; }

                stopTimer();

                // Show time + chip bonus locally (server should mirror)
                const rawMs = data.time_ms || (Date.now() - state.startedMs);
                const bonusMs = Math.max(0, state.chips * CHIPS_TO_MS);
                const effMs = Math.max(0, rawMs - bonusMs);

                $("finalStatus").innerHTML = `
          <div class="status ok">Escaped! Time submitted.</div>
          <div class="tiny">Raw: <b>${fmtTime(rawMs)}</b> • Chip bonus: <b>-${fmtTime(bonusMs)}</b> (${state.chips} chips × ${CHIPS_TO_MS}ms)
            • Effective: <b>${fmtTime(effMs)}</b></div>
        `;
                const shareTxt = `I escaped today’s Mini Escape in ${fmtTime(effMs)} (chip bonus applied). Can you beat me?`;
                $("shareText").textContent = shareTxt;
                $("copyBtn").onclick = async () => {
                    try {
                        await navigator.clipboard.writeText(`${shareTxt} ${window.location.origin}/escape/today`);
                        toast("Copied!");
                    } catch (e) { toast("Copy failed"); }
                };
                $("share").style.display = "block";
            } catch (e) {
                $("finalStatus").textContent = "Network error — try again."; $("finalStatus").className = "status err";
            }
        });

        // ---------- Keyboard shortcut ----------
        document.addEventListener("keydown", (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
                const idx = state.currentScene; const btn = document.getElementById(`pzbtn-${idx}`);
                if (btn && !btn.disabled) btn.click();
            }
        });
    </script>
</body>

</html>