{% extends "base.html" %}
{% block title %}Timeline Roulette — {{ round_date.strftime("%b %d, %Y") }}{% endblock %}
{% block content %}

<section class="container" style="max-width:900px;margin:2rem auto;padding:0 1rem;">
    <h1 class="mb-2">Timeline Roulette</h1>

    <p class="mt-4">
        <a href="{{ url_for('landing') }}"
            class="inline-block px-4 py-2 rounded-xl bg-blue-600 text-white font-semibold shadow hover:bg-blue-700 transition">
            ← Back to Homepage
        </a>
    </p>

    <p class="text-muted" style="margin:0.75rem 0 1rem;">
        Two are fakes. One really happened on {{ round_date.strftime("%B %d") }}. Pick the real one.
    </p>

    <!-- Correct index is passed via data attribute to avoid Jinja/JS brace collisions -->
    <div id="cardsWrap" data-correct="{{ correct_index|int }}">
        <div id="cards" class="grid" style="display:grid;grid-template-columns:1fr;gap:14px;">
            {% for c in cards %}
            <button class="card" type="button" data-ui-idx="{{ loop.index0 }}"
                style="padding:12px 16px;border-radius:14px;border:1px solid #e5e7eb;background:#fff;text-align:left;cursor:pointer;">
                <div style="display:flex;align-items:center;gap:12px;">
                    {% if c.icon %}
                    <img class="icon" src="{{ c.icon }}" alt="" width="60" height="60" loading="lazy" decoding="async"
                        referrerpolicy="no-referrer"
                        style="width:60px;height:60px;border-radius:9999px;object-fit:cover;background:#f3f4f6;padding:10px;flex:0 0 auto;">
                    {% endif %}
                    <div>
                        <div style="font-weight:600;color:#374151;">Event {{ loop.index }}</div>
                        <div style="color:#111827;">{{ c.text }}</div>
                    </div>
                </div>
            </button>
            {% endfor %}
        </div>
    </div>

    <div id="result" style="display:none;margin-top:14px;font-weight:600;"></div>

    <div class="mt-2" style="margin-top:10px;">
        <a href="{{ source_url }}" target="_blank" rel="noopener" style="display:none;" id="sourceLink">
            Read the real event →
        </a>
    </div>

    <div id="stats" style="margin-top:10px;color:#6b7280;font-size:0.95rem;">
        Today: <span id="statPlays">{{ day_total }}</span> plays,
        <span id="statCorrect">{{ day_correct }}</span> correct.
        • Your streak:
        <span id="streak">{{ guest_streak or 0 }}</span> days
        • <a href="{{ url_for('roulette.leaderboard') }}">Leaderboard</a>
    </div>

    {% if img_attr %}
    <div style="margin-top:6px;color:#9ca3af;font-size:0.8rem;">
        Images via Unsplash — {{ img_attr }}
    </div>
    {% endif %}
</section>

<script>
    (function () {
        // Minimal inline fallback avatar (always safe)
        const FALLBACK_DATA_URI =
            "data:image/svg+xml;utf8," +
            '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">' +
            '<circle cx="32" cy="32" r="30" fill="%23f3f4f6" stroke="%23e5e7eb" stroke-width="2"/>' +
            '<circle cx="32" cy="26" r="10" fill="%23e5e7eb"/>' +
            '<rect x="14" y="40" width="36" height="14" rx="7" fill="%23e5e7eb"/>' +
            '</svg>';

        // Apply robust onerror fallback for all icons
        document.querySelectorAll('#cards img.icon').forEach(img => {
            img.onerror = () => {
                // Swap to a guaranteed inline avatar once
                if (img.dataset.fallbackApplied !== "1") {
                    img.src = FALLBACK_DATA_URI;
                    img.dataset.fallbackApplied = "1";
                }
            };
        });

        const wrap = document.getElementById("cardsWrap");
        const correctIndex = parseInt(wrap.dataset.correct, 10);
        const cards = Array.from(document.querySelectorAll("#cards .card"));
        const sourceLink = document.getElementById("sourceLink");
        const resultBox = document.getElementById("result");
        const statPlays = document.getElementById("statPlays");
        const statCorrect = document.getElementById("statCorrect");
        const streakEl = document.getElementById("streak");
        let clicked = false;

        function reveal(pick) {
            cards.forEach((btn, i) => {
                btn.style.borderColor = (i === correctIndex) ? "#10b981" : "#ef4444";
                btn.style.background = (i === correctIndex) ? "#ecfdf5" : "#fff";
            });
            sourceLink.style.display = "inline-block";
            resultBox.style.display = "block";
            resultBox.textContent = (pick === correctIndex)
                ? "✅ Correct! You spotted the real one."
                : "❌ Not quite. That one was an AI fake.";
        }

        cards.forEach((btn, i) => {
            btn.addEventListener("click", async () => {
                if (clicked) return;
                clicked = true;

                // lock UI
                cards.forEach(b => { b.disabled = true; b.style.opacity = "0.85"; b.style.cursor = "default"; });

                const pick = i;
                reveal(pick);

                try {
                    const res = await fetch("/roulette/guess", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ choice: pick, correct_index: correctIndex })
                    });
                    if (res.ok) {
                        const data = await res.json();
                        if (data && data.totals) {
                            statPlays.textContent = data.totals.plays;
                            statCorrect.textContent = data.totals.correct;
                        }
                        if (data && data.streak !== undefined && data.streak !== null) {
                            streakEl.textContent = data.streak;
                        }
                    }
                } catch (_) {
                    // ignore; UI already updated locally
                }
            });
        });
    })();
</script>

{% endblock %}